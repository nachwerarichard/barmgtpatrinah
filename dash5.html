<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Business Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-white to-purple-50 min-h-screen">
    <div class="max-w-4xl mx-auto p-4 h-screen flex flex-col">
        <!-- Header -->
        <div class="bg-white rounded-t-2xl shadow-lg p-6 border-b border-gray-200">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-br from-indigo-500 to-purple-600 p-3 rounded-xl">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">AI Business Assistant</h1>
                    <p class="text-sm text-gray-600">Intelligent Business Analysis</p>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="bg-white px-6 py-4 border-b border-gray-200">
            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">Quick Actions</p>
            <div class="flex gap-2 flex-wrap" id="quickActions">
                <button class="quick-action flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-indigo-50 to-purple-50 hover:from-indigo-100 hover:to-purple-100 text-indigo-700 rounded-lg text-sm font-medium transition-all" data-prompt="Show me a business summary">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Business Summary
                </button>
                <button class="quick-action flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-indigo-50 to-purple-50 hover:from-indigo-100 hover:to-purple-100 text-indigo-700 rounded-lg text-sm font-medium transition-all" data-prompt="Check inventory status">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                    Inventory Check
                </button>
                <button class="quick-action flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-indigo-50 to-purple-50 hover:from-indigo-100 hover:to-purple-100 text-indigo-700 rounded-lg text-sm font-medium transition-all" data-prompt="What are my top expenses?">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Top Expenses
                </button>
                <button class="quick-action flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-indigo-50 to-purple-50 hover:from-indigo-100 hover:to-purple-100 text-indigo-700 rounded-lg text-sm font-medium transition-all" data-prompt="Analyze my profit">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                    </svg>
                    Profit Analysis
                </button>
            </div>
        </div>

        <!-- Messages -->
        <div class="flex-1 overflow-y-auto bg-white p-6 space-y-4" id="messagesContainer">
            <div class="flex justify-start">
                <div class="max-w-[80%] rounded-2xl px-4 py-3 bg-gray-100 text-gray-900">
                    <div class="flex items-center gap-2 mb-2">
                        <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        <span class="text-xs font-semibold text-indigo-600">AI Assistant</span>
                    </div>
                    <div class="whitespace-pre-wrap text-sm leading-relaxed">Hello! üëã I'm your intelligent business assistant. I can help you with:

‚Ä¢ <strong>Business Overview</strong> - Get summaries of sales, expenses, and profit
‚Ä¢ <strong>Sales Analysis</strong> - View revenue trends and top-selling items
‚Ä¢ <strong>Inventory Management</strong> - Check stock levels and low inventory alerts
‚Ä¢ <strong>Expense Tracking</strong> - Monitor spending and identify top expenses
‚Ä¢ <strong>Profit Insights</strong> - Calculate margins and profitability

Try asking: "Show me a business summary" or "Which items need restocking?"</div>
                </div>
            </div>
        </div>

        <!-- Input -->
        <div class="bg-white rounded-b-2xl shadow-lg p-4 border-t border-gray-200">
            <div class="flex gap-2">
                <textarea 
                    id="messageInput"
                    placeholder="Ask about your business data: sales, inventory, expenses, profit..."
                    class="flex-1 resize-none rounded-xl border border-gray-300 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    rows="2"
                ></textarea>
                <button
                    id="sendButton"
                    class="bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white rounded-xl px-6 py-3 font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 self-end"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                    Send
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://patrinahhotelmgtsys.onrender.com';
        let isLoading = false;

        // DOM Elements
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const quickActions = document.querySelectorAll('.quick-action');

        // Initialize
        function init() {
            sendButton.addEventListener('click', handleSend);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            });

            quickActions.forEach(button => {
                button.addEventListener('click', () => {
                    const prompt = button.dataset.prompt;
                    messageInput.value = prompt;
                    handleSend();
                });
            });
        }

        // Add message to UI
        function addMessage(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex ' + (role === 'user' ? 'justify-end' : 'justify-start');
            
            const contentDiv = document.createElement('div');
            const contentClass = role === 'user' 
                ? 'max-w-[80%] rounded-2xl px-4 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white'
                : 'max-w-[80%] rounded-2xl px-4 py-3 bg-gray-100 text-gray-900';
            contentDiv.className = contentClass;

            if (role === 'assistant') {
                contentDiv.innerHTML = '<div class="flex items-center gap-2 mb-2">' +
                    '<svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>' +
                    '</svg>' +
                    '<span class="text-xs font-semibold text-indigo-600">AI Assistant</span>' +
                    '</div>' +
                    '<div class="whitespace-pre-wrap text-sm leading-relaxed">' + content + '</div>';
            } else {
                contentDiv.innerHTML = '<div class="whitespace-pre-wrap text-sm leading-relaxed">' + content + '</div>';
            }

            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        // Show loading indicator
        function showLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingIndicator';
            loadingDiv.className = 'flex justify-start';
            loadingDiv.innerHTML = '<div class="bg-gray-100 rounded-2xl px-4 py-3">' +
                '<div class="flex items-center gap-2">' +
                '<svg class="w-4 h-4 animate-spin text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>' +
                '</svg>' +
                '<span class="text-sm text-gray-600">Analyzing your business data...</span>' +
                '</div>' +
                '</div>';
            messagesContainer.appendChild(loadingDiv);
            scrollToBottom();
        }

        // Remove loading indicator
        function hideLoading() {
            const loadingDiv = document.getElementById('loadingIndicator');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        // Scroll to bottom
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Fetch business data
        async function fetchBusinessData() {
            const token = localStorage.getItem('token');
            
            if (!token) {
                throw new Error('No authentication token found. Please log in first.');
            }

            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
            
            const salesRes = await fetch(API_BASE + '/sales?limit=50', { headers });
            const inventoryRes = await fetch(API_BASE + '/inventory?limit=50', { headers });
            const expensesRes = await fetch(API_BASE + '/expenses?limit=50', { headers });

            if (!salesRes.ok || !inventoryRes.ok || !expensesRes.ok) {
                throw new Error('Failed to fetch business data. Please check your connection or login status.');
            }

            const salesData = await salesRes.json();
            const inventoryData = await inventoryRes.json();
            const expensesData = await expensesRes.json();

            return { 
                sales: salesData.data || [], 
                inventory: inventoryData.data || [], 
                expenses: expensesData.data || [] 
            };
        }

        // Format currency
        function formatCurrency(amount) {
            return 'UGX ' + Math.round(amount).toLocaleString();
        }

        // Generate intelligent response based on query
        function generateResponse(query, data) {
            const lowerQuery = query.toLowerCase();
            const { sales, inventory, expenses } = data;

            // Calculate key metrics
            const totalSales = sales.reduce((sum, s) => sum + (s.amount || 0), 0);
            const totalExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
            const profit = totalSales - totalExpenses;
            const profitMargin = totalSales > 0 ? ((profit / totalSales) * 100).toFixed(1) : 0;

            // Business Summary / Overview / Dashboard
            if (lowerQuery.includes('summary') || lowerQuery.includes('overview') || 
                lowerQuery.includes('dashboard') || lowerQuery.includes('status') ||
                lowerQuery.includes('how') && (lowerQuery.includes('doing') || lowerQuery.includes('business'))) {
                
                const lowStock = inventory.filter(item => item.closing < 10);
                const avgSale = sales.length > 0 ? (totalSales / sales.length) : 0;
                
                return `üìä <strong>Business Performance Summary</strong>

üí∞ <strong>Financial Overview:</strong>
‚Ä¢ Total Sales: ${formatCurrency(totalSales)} (${sales.length} transactions)
‚Ä¢ Total Expenses: ${formatCurrency(totalExpenses)} (${expenses.length} items)
‚Ä¢ Net Profit: ${formatCurrency(profit)}
‚Ä¢ Profit Margin: ${profitMargin}%

üì¶ <strong>Inventory Status:</strong>
‚Ä¢ Total Items: ${inventory.length}
‚Ä¢ Low Stock Alerts: ${lowStock.length} items
${lowStock.length > 0 ? '‚Ä¢ Items Needing Restock: ' + lowStock.slice(0, 5).map(i => i.item).join(', ') : '‚Ä¢ All items adequately stocked'}

üìà <strong>Sales Insights:</strong>
‚Ä¢ Average Transaction: ${formatCurrency(avgSale)}
‚Ä¢ Performance: ${profit > 0 ? '‚úÖ Profitable' : '‚ö†Ô∏è Needs Attention'}

${profit < 0 ? '\n‚ö†Ô∏è <strong>Recommendation:</strong> Your expenses exceed sales. Consider reviewing high-cost items and focusing on revenue growth strategies.' : ''}`;
            }

            // Sales queries
            if (lowerQuery.includes('sales') || lowerQuery.includes('revenue') || lowerQuery.includes('income')) {
                if (sales.length === 0) {
                    return 'üìä <strong>Sales Report</strong>\n\nNo sales records found. Start recording your sales to see insights here.';
                }

                // Group sales by item/category if available
                const salesByItem = {};
                sales.forEach(sale => {
                    const item = sale.item || 'Other';
                    salesByItem[item] = (salesByItem[item] || 0) + (sale.amount || 0);
                });

                const topItems = Object.entries(salesByItem)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                let response = `üí∞ <strong>Sales Analysis</strong>

<strong>Revenue Summary:</strong>
‚Ä¢ Total Sales: ${formatCurrency(totalSales)}
‚Ä¢ Number of Transactions: ${sales.length}
‚Ä¢ Average Sale: ${formatCurrency(totalSales / sales.length)}`;

                if (topItems.length > 0 && topItems[0][0] !== 'Other') {
                    response += `\n\n<strong>Top Selling Items:</strong>\n`;
                    topItems.forEach(([item, amount], idx) => {
                        response += `${idx + 1}. ${item}: ${formatCurrency(amount)}\n`;
                    });
                }

                response += `\nüí° <strong>Insight:</strong> `;
                if (totalSales > totalExpenses) {
                    response += `Your sales are exceeding expenses by ${formatCurrency(profit)}. Great work! Consider reinvesting in top-performing items.`;
                } else {
                    response += `Focus on increasing sales volume and promoting your best-selling items to improve profitability.`;
                }

                return response;
            }

            // Inventory queries
            if (lowerQuery.includes('inventory') || lowerQuery.includes('stock') || 
                lowerQuery.includes('restock') || lowerQuery.includes('items')) {
                
                if (inventory.length === 0) {
                    return 'üì¶ <strong>Inventory Report</strong>\n\nNo inventory records found. Add items to your inventory to track stock levels.';
                }

                const lowStock = inventory.filter(item => item.closing < 10);
                const outOfStock = inventory.filter(item => item.closing === 0);
                const adequateStock = inventory.filter(item => item.closing >= 10);
                const totalValue = inventory.reduce((sum, item) => sum + ((item.closing || 0) * (item.price || 0)), 0);

                let response = `üì¶ <strong>Inventory Status Report</strong>

<strong>Stock Overview:</strong>
‚Ä¢ Total Items: ${inventory.length}
‚Ä¢ Items in Stock: ${adequateStock.length}
‚Ä¢ Low Stock: ${lowStock.length} items
‚Ä¢ Out of Stock: ${outOfStock.length} items`;

                if (lowStock.length > 0) {
                    response += `\n\n‚ö†Ô∏è <strong>Low Stock Alerts:</strong>\n`;
                    lowStock.slice(0, 10).forEach(item => {
                        response += `‚Ä¢ ${item.item}: ${item.closing} units remaining\n`;
                    });
                }

                if (outOfStock.length > 0) {
                    response += `\n\nüö® <strong>Out of Stock:</strong>\n`;
                    outOfStock.slice(0, 5).forEach(item => {
                        response += `‚Ä¢ ${item.item}\n`;
                    });
                }

                response += `\n\nüí° <strong>Recommendation:</strong> `;
                if (lowStock.length > 0) {
                    response += `Reorder ${lowStock.length} items to avoid stockouts. Maintain at least 10-15 units of fast-moving items.`;
                } else {
                    response += `Your inventory levels look healthy! Continue monitoring daily to stay ahead of demand.`;
                }

                return response;
            }

            // Expense queries
            if (lowerQuery.includes('expense') || lowerQuery.includes('cost') || 
                lowerQuery.includes('spending') || lowerQuery.includes('spend')) {
                
                if (expenses.length === 0) {
                    return 'üí≥ <strong>Expense Report</strong>\n\nNo expense records found. Track your expenses to better manage costs.';
                }

                // Group expenses by category
                const expensesByCategory = {};
                expenses.forEach(expense => {
                    const category = expense.category || expense.description || 'Other';
                    expensesByCategory[category] = (expensesByCategory[category] || 0) + (expense.amount || 0);
                });

                const topExpenses = Object.entries(expensesByCategory)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                let response = `üí≥ <strong>Expense Analysis</strong>

<strong>Spending Summary:</strong>
‚Ä¢ Total Expenses: ${formatCurrency(totalExpenses)}
‚Ä¢ Number of Expenses: ${expenses.length}
‚Ä¢ Average Expense: ${formatCurrency(totalExpenses / expenses.length)}

<strong>Top Expense Categories:</strong>
`;
                topExpenses.forEach(([category, amount], idx) => {
                    const percentage = ((amount / totalExpenses) * 100).toFixed(1);
                    response += `${idx + 1}. ${category}: ${formatCurrency(amount)} (${percentage}%)\n`;
                });

                response += `\nüí° <strong>Cost Management Tips:</strong>\n`;
                if (totalExpenses > totalSales * 0.7) {
                    response += `‚Ä¢ Your expenses are ${((totalExpenses/totalSales)*100).toFixed(0)}% of sales. Aim to reduce to 60-70%\n`;
                    response += `‚Ä¢ Review your top expense category: ${topExpenses[0][0]}\n`;
                    response += `‚Ä¢ Look for cost-saving opportunities in recurring expenses`;
                } else {
                    response += `‚Ä¢ Your expense ratio is healthy at ${((totalExpenses/totalSales)*100).toFixed(0)}% of sales\n`;
                    response += `‚Ä¢ Continue monitoring ${topExpenses[0][0]} as your largest expense\n`;
                    response += `‚Ä¢ Maintain this discipline for sustained profitability`;
                }

                return response;
            }

            // Profit queries
            if (lowerQuery.includes('profit') || lowerQuery.includes('margin') || 
                lowerQuery.includes('earning') || lowerQuery.includes('net')) {
                
                let response = `üìà <strong>Profitability Analysis</strong>

<strong>Financial Performance:</strong>
‚Ä¢ Total Revenue: ${formatCurrency(totalSales)}
‚Ä¢ Total Costs: ${formatCurrency(totalExpenses)}
‚Ä¢ Net Profit: ${formatCurrency(profit)}
‚Ä¢ Profit Margin: ${profitMargin}%

<strong>Status:</strong> ${profit > 0 ? '‚úÖ Profitable' : '‚ö†Ô∏è Operating at a Loss'}

`;

                if (profit > 0) {
                    response += `üéâ <strong>Great job!</strong> Your business is profitable.\n\n`;
                    response += `<strong>Growth Strategies:</strong>\n`;
                    response += `‚Ä¢ Reinvest ${(profit * 0.3).toFixed(0)} (30%) back into inventory\n`;
                    response += `‚Ä¢ Focus on scaling your top-selling items\n`;
                    response += `‚Ä¢ Consider expanding product range based on demand`;
                } else {
                    response += `‚ö†Ô∏è <strong>Action Required:</strong> You need to improve profitability.\n\n`;
                    response += `<strong>Immediate Steps:</strong>\n`;
                    response += `‚Ä¢ Reduce expenses by ${formatCurrency(Math.abs(profit))} to break even\n`;
                    response += `‚Ä¢ Increase sales focus on high-margin items\n`;
                    response += `‚Ä¢ Review and cut non-essential expenses\n`;
                    response += `‚Ä¢ Consider price adjustments for better margins`;
                }

                return response;
            }

            // Trends / performance / growth
            if (lowerQuery.includes('trend') || lowerQuery.includes('performance') || 
                lowerQuery.includes('grow') || lowerQuery.includes('improve')) {
                
                return `üìä <strong>Business Performance & Growth Insights</strong>

<strong>Current Metrics:</strong>
‚Ä¢ Revenue: ${formatCurrency(totalSales)}
‚Ä¢ Profit: ${formatCurrency(profit)} (${profitMargin}% margin)
‚Ä¢ Inventory Items: ${inventory.length}

<strong>Growth Opportunities:</strong>

1Ô∏è‚É£ <strong>Revenue Growth:</strong>
   ‚Ä¢ Promote best-selling items
   ‚Ä¢ Introduce bundled offers
   ‚Ä¢ Focus on customer retention

2Ô∏è‚É£ <strong>Cost Optimization:</strong>
   ‚Ä¢ Negotiate better supplier rates
   ‚Ä¢ Reduce waste and spoilage
   ‚Ä¢ Optimize inventory turnover

3Ô∏è‚É£ <strong>Inventory Management:</strong>
   ‚Ä¢ Stock popular items adequately
   ‚Ä¢ Reduce slow-moving inventory
   ‚Ä¢ Implement just-in-time ordering

4Ô∏è‚É£ <strong>Profitability:</strong>
   ‚Ä¢ Target 20-30% profit margins
   ‚Ä¢ Review pricing strategy
   ‚Ä¢ Focus on high-margin products

üí° <strong>Next Step:</strong> Focus on your top 3 selling items and ensure they're always in stock to maximize revenue.`;
            }

            // Help / What can you do
            if (lowerQuery.includes('help') || lowerQuery.includes('what can') || 
                lowerQuery.includes('how to') || lowerQuery.includes('assist')) {
                
                return `ü§ñ <strong>I'm Your Business Intelligence Assistant!</strong>

I can help you analyze and understand your business data. Try asking me:

üìä <strong>Business Overview:</strong>
‚Ä¢ "Show me a business summary"
‚Ä¢ "How is my business doing?"
‚Ä¢ "Give me a dashboard"

üí∞ <strong>Sales Analysis:</strong>
‚Ä¢ "What are my total sales?"
‚Ä¢ "Show me revenue"
‚Ä¢ "What are my top selling items?"

üì¶ <strong>Inventory Management:</strong>
‚Ä¢ "Check inventory status"
‚Ä¢ "What items need restocking?"
‚Ä¢ "Show me low stock items"

üí≥ <strong>Expense Tracking:</strong>
‚Ä¢ "What are my expenses?"
‚Ä¢ "Show me top expenses"
‚Ä¢ "How much am I spending?"

üìà <strong>Profitability:</strong>
‚Ä¢ "Analyze my profit"
‚Ä¢ "What's my profit margin?"
‚Ä¢ "Am I making money?"

Just ask in plain English and I'll analyze your data!`;
            }

            // Default response - provide helpful guidance
            return `I'm here to help you understand your business data! 

Your current business snapshot:
‚Ä¢ Sales: ${formatCurrency(totalSales)}
‚Ä¢ Expenses: ${formatCurrency(totalExpenses)}
‚Ä¢ Profit: ${formatCurrency(profit)}
‚Ä¢ Inventory: ${inventory.length} items

Try asking me things like:
‚Ä¢ "Show me a business summary"
‚Ä¢ "Check inventory status"
‚Ä¢ "What are my top expenses?"
‚Ä¢ "Analyze my profit"
‚Ä¢ "How can I improve sales?"

What would you like to know?`;
        }

        // Handle send message
        async function handleSend() {
            const messageText = messageInput.value.trim();
            
            if (!messageText || isLoading) return;

            // Add user message
            addMessage('user', messageText);
            
            // Clear input
            messageInput.value = '';
            
            // Set loading state
            isLoading = true;
            sendButton.disabled = true;
            messageInput.disabled = true;
            quickActions.forEach(btn => btn.disabled = true);
            showLoading();

            try {
                // Fetch business data
                const businessData = await fetchBusinessData();
                
                // Generate intelligent response
                const response = generateResponse(messageText, businessData);
                
                // Add assistant message
                hideLoading();
                addMessage('assistant', response);

            } catch (error) {
                console.error('Error:', error);
                hideLoading();
                
                let errorMessage = '‚ùå <strong>Error:</strong> ' + error.message;
                
                if (error.message.includes('authentication')) {
                    errorMessage += '\n\nüí° Please log in to access your business data.';
                } else {
                    errorMessage += '\n\nüí° Please check your connection and try again.';
                }
                
                addMessage('assistant', errorMessage);
            } finally {
                // Reset loading state
                isLoading = false;
                sendButton.disabled = false;
                messageInput.disabled = false;
                quickActions.forEach(btn => btn.disabled = false);
                messageInput.focus();
            }
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
