<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patrinah Hotel Management System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Custom Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <!-- Inline styles for modal control -->
    <style>
        .modal {
            display: none; /* Controlled by JS to be 'flex' */
        }
        .section.active {
            display: block;
        }
        .section:not(.active) {
            display: none;
        }
        .active-nav-item {
            background-color: #3b82f6; /* bg-blue-500 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="font-sans min-h-screen bg-gray-100">
    
    <!-- Login Section - Visible initially -->
    <div id="login-section" class="flex flex-col items-center justify-center min-h-screen p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <img src="https://placehold.co/100x100/3b82f6/ffffff?text=P" alt="Patrinah Hotel Logo" class="w-24 h-24 mb-6 mx-auto rounded-full">
            <h2 class="text-3xl font-bold mb-6 text-gray-800 text-center">Patrinah HMS</h2>
            <input type="text" id="username" placeholder="Username (e.g., Richard)" class="mb-4 p-3 border border-gray-300 rounded-lg w-full focus:ring-blue-500 focus:border-blue-500 transition duration-150">
            <input type="password" id="password" placeholder="Password (e.g., 123)" class="mb-6 p-3 border border-gray-300 rounded-lg w-full focus:ring-blue-500 focus:border-blue-500 transition duration-150">
            <button type="submit" onclick="login()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg w-full transition duration-150 ease-in-out shadow-md hover:shadow-lg">
                Login
            </button>
            <p id="login-message" class="mt-4 text-red-600 text-center font-medium"></p>
        </div>
    </div>

    <!-- Main Container - Hidden initially, becomes the two-column layout -->
    <div id="main-container" class="hidden min-h-screen flex flex-col">
        
        <!-- Header (Top Bar) -->
        <header class="flex justify-between items-center p-4 bg-white border-b border-gray-200 shadow-md flex-shrink-0">
            <div class="flex items-center">
                <img src="https://placehold.co/40x40/3b82f6/ffffff?text=P" alt="Logo" class="h-10 w-10 mr-3 rounded-full">
                <h1 class="text-xl font-bold text-gray-800 hidden sm:block">Hotel Management</h1>
            </div>
            
            <div class="flex items-center space-x-4">
                <!-- Mobile Menu Toggle -->
                <button id="menu-toggle" onclick="toggleMobileNav()" class="lg:hidden text-gray-600 hover:text-blue-600 p-2 rounded-md transition duration-150">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                
                <div class="flex items-center space-x-4 hidden sm:flex">
                    <span id="current-user-display" class="text-gray-600 font-medium">User Role</span>
                    <button id="logout-button" onclick="logout()" class="flex items-center bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition duration-150 shadow-md">
                        Logout <i class="fas fa-sign-out-alt ml-2"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content Area: Sidebar (Vertical Nav) and Content Panel -->
        <div class="flex flex-1 overflow-hidden">
            
            <!-- Sidebar Navigation (Vertical on Left) -->
            <!-- Hidden on small screens, shown as fixed sidebar on large screens -->
            <nav id="main-nav" class="hidden lg:block w-64 bg-gray-800 text-white p-4 space-y-2 flex-shrink-0 shadow-xl overflow-y-auto">
                <button id="nav-inventory" onclick="showSection('inventory', this)" class="nav-item w-full flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-150 text-left font-medium active-nav-item">
                    <i class="fas fa-boxes w-5 mr-3"></i> Inventory
                </button>
                <button id="nav-sales" onclick="showSection('sales', this)" class="nav-item w-full flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-150 text-left font-medium">
                    <i class="fas fa-chart-line w-5 mr-3"></i> Sales
                </button>
                <button id="nav-expenses" onclick="showSection('expenses', this)" class="nav-item w-full flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-150 text-left font-medium">
                    <i class="fas fa-money-bill-wave w-5 mr-3"></i> Expenses
                </button>
                <button id="nav-cash-management" onclick="showSection('cash-management', this)" class="nav-item w-full flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-150 text-left font-medium">
                    <i class="fas fa-wallet w-5 mr-3"></i> Cash Management
                </button>
                <button id="nav-reports" onclick="showSection('reports', this)" class="nav-item w-full flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-150 text-left font-medium">
                    <i class="fas fa-file-invoice-dollar w-5 mr-3"></i> Reports
                </button>
                <button id="nav-audit-logs" onclick="showSection('audit-logs', this)" class="nav-item w-full flex items-center p-3 rounded-lg hover:bg-gray-700 transition duration-150 text-left font-medium">
                    <i class="fas fa-history w-5 mr-3"></i> Audit Logs
                </button>
            </nav>
            
            <!-- Mobile Navigation (Appears as a full-screen overlay) -->
            <nav id="mobile-nav" class="fixed inset-0 z-40 bg-gray-900 bg-opacity-95 p-6 space-y-4 flex flex-col hidden lg:hidden transition duration-300 ease-in-out transform">
                <button onclick="toggleMobileNav()" class="text-white self-end text-3xl hover:text-red-500"><i class="fas fa-times"></i></button>
                <img src="https://placehold.co/60x60/3b82f6/ffffff?text=P" alt="Logo" class="h-16 w-16 self-center mb-4 rounded-full">
                
                <a href="#" onclick="showSection('inventory', document.getElementById('nav-inventory')); toggleMobileNav()" class="text-white text-lg font-medium hover:text-blue-400 transition duration-150 py-2 border-b border-gray-700">Inventory</a>
                <a href="#" onclick="showSection('sales', document.getElementById('nav-sales')); toggleMobileNav()" class="text-white text-lg font-medium hover:text-blue-400 transition duration-150 py-2 border-b border-gray-700">Sales</a>
                <a href="#" onclick="showSection('expenses', document.getElementById('nav-expenses')); toggleMobileNav()" class="text-white text-lg font-medium hover:text-blue-400 transition duration-150 py-2 border-b border-gray-700">Expenses</a>
                <a href="#" onclick="showSection('cash-management', document.getElementById('nav-cash-management')); toggleMobileNav()" class="text-white text-lg font-medium hover:text-blue-400 transition duration-150 py-2 border-b border-gray-700">Cash Management</a>
                <a href="#" onclick="showSection('reports', document.getElementById('nav-reports')); toggleMobileNav()" class="text-white text-lg font-medium hover:text-blue-400 transition duration-150 py-2 border-b border-gray-700">Reports</a>
                <a href="#" onclick="showSection('audit-logs', document.getElementById('nav-audit-logs')); toggleMobileNav()" class="text-white text-lg font-medium hover:text-blue-400 transition duration-150 py-2 border-b border-gray-700">Audit Logs</a>
                
                <a href="#" onclick="logout(); toggleMobileNav()" class="text-red-400 text-lg font-medium hover:text-red-500 transition duration-150 pt-4 mt-auto text-center">Logout</a>
            </nav>

            <!-- Main Content Panel (Right side) -->
            <div id="main-content" class="flex-1 p-6 bg-gray-50 overflow-y-auto">
                
                <!-- Inventory Section -->
                <div id="inventory-section" class="section active p-6 bg-white rounded-xl shadow-lg transition duration-300">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-3">Inventory Management</h2>
                    
                    <!-- Add/Update Form -->
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">Add/Update Inventory Item</h3>
                    <form id="inventory-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8 p-6 border border-gray-200 rounded-lg bg-gray-50 shadow-inner">
                        <input type="hidden" id="inventory-id">
                        
                        <div class="col-span-full">
                            <label for="item" class="block text-sm font-medium text-gray-700 mb-1">Item:</label>
                            <input type="text" id="item" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                        </div>
                        
                        <div class="md:col-span-1">
                            <label for="opening" class="block text-sm font-medium text-gray-700 mb-1">Opening Stock:</label>
                            <input type="number" id="opening" min="0" required class="w-full p-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="md:col-span-1">
                            <label for="purchases" class="block text-sm font-medium text-gray-700 mb-1">Purchases:</label>
                            <input type="number" id="purchases" min="0" required class="w-full p-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="md:col-span-1">
                            <label for="inventory-sales" class="block text-sm font-medium text-gray-700 mb-1">Sales (deducted):</label>
                            <input type="number" id="inventory-sales" min="0" required class="w-full p-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="md:col-span-1">
                            <label for="spoilage" class="block text-sm font-medium text-gray-700 mb-1">Spoilage:</label>
                            <input type="number" id="spoilage" min="0" required class="w-full p-2 border border-gray-300 rounded-lg">
                        </div>
                        
                        <button type="submit" class="md:col-span-3 lg:col-span-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-center transition duration-150 mt-2 shadow-md hover:shadow-lg">
                            <i class="fas fa-save mr-2"></i> Save Inventory
                        </button>
                    </form>
                    
                    <!-- Inventory Table and Controls -->
                    <h3 class="text-xl font-semibold mb-4 text-gray-700 border-t pt-4">Current Inventory</h3>
                    <div class="flex flex-wrap gap-3 mb-4 items-end">
                        <input type="date" id="search-inventory-date" placeholder="Filter by date" class="p-2 border rounded-lg">
                        <input type="text" class="hidden p-2 border rounded-lg" id="search-inventory-item" placeholder="Search by item name">
                        <input type="number" class="hidden p-2 border rounded-lg" id="search-inventory-low" placeholder="Filter by closing stock <">
                        <button onclick="fetchInventory()" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg flex items-center transition duration-150 shadow-sm"> 
                            Search<i class="fas fa-search ml-2"></i>
                        </button>
                        <button class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150 shadow-sm" onclick="exportTableToExcel('table-responsive', 'Inventory_Report_SheetJS')">
                            Export to Excel
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto border rounded-xl shadow-md" id="table-responsive">
                        <table id="inventory-table" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Opening</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Purchases</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sales</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Spoilage</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Closing</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <!-- Dynamic rows -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="pagination" class="flex justify-end mt-4"></div>
                </div>
                
                <!-- Sales Section -->
                <div id="sales-section" class="section hidden p-6 bg-white rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-3">Sales Management</h2>
                    <!-- ... Sales Form and Table content using Tailwind ... -->
                </div>
                
                <!-- Expenses Section -->
                <div id="expenses-section" class="section hidden p-6 bg-white rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-3">Expenses Management</h2>
                    <!-- ... Expenses Form and Table content using Tailwind ... -->
                </div>
                
                <!-- Cash Management Section -->
                <div id="cash-management-section" class="section hidden p-6 bg-white rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-3">Cash Management</h2>
                    <!-- ... Cash Management Form and Table content using Tailwind ... -->
                </div>
                
                <!-- Reports Section -->
                <div id="reports-section" class="section hidden p-6 bg-white rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-3">Financial Reports</h2>
                    <!-- ... Reports controls and tables using Tailwind ... -->
                </div>
                
                <!-- Audit Logs Section -->
                <div id="audit-logs-section" class="section hidden p-6 bg-white rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-3">Audit Logs</h2>
                    <!-- ... Audit Logs search and table using Tailwind ... -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Inventory Modal -->
    <div id="edit-inventory-modal" class="modal fixed inset-0 z-50 bg-black bg-opacity-50 justify-center items-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg mx-4 relative transform transition-all duration-300 scale-100">
            <span class="close-button absolute top-3 right-5 text-gray-500 text-3xl font-bold cursor-pointer hover:text-black" onclick="closeEditModal()">&times;</span>
            <h3 class="text-2xl font-bold mb-4 border-b pb-2 text-gray-800">Edit Inventory Item</h3>
            <form id="edit-inventory-form" class="space-y-4">
                <input type="hidden" id="edit-inventory-id">
                
                <div>
                    <label for="edit-item" class="block text-sm font-medium text-gray-700">Item:</label>
                    <input type="text" id="edit-item" required class="mt-1 p-2 border border-gray-300 rounded-lg w-full">
                </div>
                
                <div>
                    <label for="edit-opening" class="block text-sm font-medium text-gray-700">Opening Stock:</label>
                    <input type="number" id="edit-opening" min="0" required class="mt-1 p-2 border border-gray-300 rounded-lg w-full">
                </div>
                
                <div>
                    <label for="edit-purchases" class="block text-sm font-medium text-gray-700">Purchases:</label>
                    <input type="number" id="edit-purchases" min="0" required class="mt-1 p-2 border border-gray-300 rounded-lg w-full">
                </div>
                
                <div>
                    <label for="edit-inventory-sales" class="block text-sm font-medium text-gray-700">Sales (deducted from inventory):</label>
                    <input type="number" id="edit-inventory-sales" min="0" required class="mt-1 p-2 border border-gray-300 rounded-lg w-full">
                </div>
                
                <div>
                    <label for="edit-spoilage" class="block text-sm font-medium text-gray-700">Spoilage:</label>
                    <input type="number" id="edit-spoilage" min="0" required class="mt-1 p-2 border border-gray-300 rounded-lg w-full">
                </div>
                
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 mt-4 shadow-md hover:shadow-lg">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Third-party library for Excel export -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <!-- Consolidated Application JavaScript with Firebase Stubs -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES & FIREBASE SETUP ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, db, auth;
        let userId = 'anonymous'; // Default placeholder
        let currentUserRole = 'Guest'; // Role for permission check in original code

        // Set log level for debugging
        setLogLevel('debug');

        // Roles and permissions check from the original context
        const ALLOWED_USERS = {
            'Richard': 'Nachwera Richard',
            'Nelson': 'Nelson',
            'Florence': 'Florence',
            'Guest': 'Guest'
        };

        // --- AUTHENTICATION & INITIALIZATION ---
        async function setupAuthAndUI() {
            try {
                // Initialize Firebase
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Set persistence (optional but good practice)
                await setPersistence(auth, browserLocalPersistence);

                // Sign in with custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Listen for authentication state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase initialized. User ID:", userId);
                        
                        // For demonstration, map the UID to a mock role if needed, 
                        // but generally, roles come from Firestore profile documents.
                        // We'll use a mock login later to set the role for demo purposes.
                        
                        // Show UI if a user object exists (this is done in `login()` for this app's flow)
                    } else {
                        userId = 'anonymous';
                        console.log("User logged out or not authenticated.");
                        showMainUI(false);
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization or Auth Error:", error);
                showMessage('Firebase setup failed. Check console for details.', 'red');
            }
        }

        // --- UI UTILITIES ---

        function showMessage(message, type = 'red') {
            const loginMessage = document.getElementById('login-message');
            loginMessage.textContent = message;
            loginMessage.className = `mt-4 text-${type}-600 text-center font-medium`;
        }

        function showMainUI(isLoggedIn) {
            document.getElementById('login-section').classList.toggle('hidden', isLoggedIn);
            document.getElementById('main-container').classList.toggle('hidden', !isLoggedIn);
            if (isLoggedIn) {
                document.getElementById('current-user-display').textContent = `User: ${currentUserRole} (${userId.substring(0, 5)}...)`;
                showSection('inventory', document.getElementById('nav-inventory')); // Default view
                // Fetch initial data
                fetchInventory();
                fetchSales();
                fetchExpenses();
            }
        }

        function toggleMobileNav() {
            document.getElementById('mobile-nav').classList.toggle('hidden');
        }

        // --- LOGIN/LOGOUT LOGIC ---

        window.login = function() {
            const usernameInput = document.getElementById('username').value;
            const passwordInput = document.getElementById('password').value; // Password is ignored for this demo

            // Simulated authentication check based on original code's implied user base
            const role = ALLOWED_USERS[usernameInput];

            if (role) {
                currentUserRole = role;
                showMessage(`Welcome, ${role}!`, 'green');
                showMainUI(true);
            } else {
                showMessage('Invalid username or password. Try Richard, Nelson, or Florence.', 'red');
            }
        }

        window.logout = async function() {
            try {
                await signOut(auth);
                currentUserRole = 'Guest';
                showMessage('Logged out successfully.', 'green');
                showMainUI(false);
            } catch(error) {
                console.error("Logout error:", error);
                showMessage('Logout failed.', 'red');
            }
        }

        // --- NAVIGATION & SECTION SWITCHING ---

        window.showSection = function(sectionId, clickedButton) {
            // 1. Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            // 2. Show the requested section
            document.getElementById(sectionId + '-section').classList.add('active');

            // 3. Update active navigation item styling (if a button was passed)
            if (clickedButton) {
                document.querySelectorAll('.nav-item').forEach(button => {
                    button.classList.remove('active-nav-item', 'bg-blue-600', 'text-white', 'shadow-md');
                    button.classList.add('hover:bg-gray-700'); // Ensure hover remains for inactive items
                });

                // Add active styles to the clicked button
                clickedButton.classList.add('active-nav-item', 'bg-blue-600', 'text-white', 'shadow-md');
                clickedButton.classList.remove('hover:bg-gray-700');
            }
        }

        // --- MODAL LOGIC (Integrated from original script) ---

        window.openEditModal = function(item) {
            const allowedToEditInventory = ['Nachwera Richard', 'Nelson', 'Florence'];
            if (!allowedToEditInventory.includes(currentUserRole)) {
                showMessage('Permission Denied: You cannot edit inventory items.');
                return;
            }

            if (!item || !item._id) {
                showMessage('Error: Inventory item data is missing or invalid.');
                return;
            }

            const modal = document.getElementById('edit-inventory-modal');
            
            // Populate the form (using a mock item object structure)
            document.getElementById('edit-inventory-id').value = item._id || '';
            document.getElementById('edit-item').value = item.item || '';
            document.getElementById('edit-opening').value = item.opening || 0;
            document.getElementById('edit-purchases').value = item.purchases || 0;
            document.getElementById('edit-inventory-sales').value = item.sales || 0;
            document.getElementById('edit-spoilage').value = item.spoilage || 0;

            modal.style.display = 'flex'; // Show the modal
        }
            
        window.closeEditModal = function() {
            document.getElementById('edit-inventory-modal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('edit-inventory-modal');
            if (event.target === modal) {
                closeEditModal();
            }
        });

        // Add event listener to the edit form (using mock data function)
        document.getElementById('edit-inventory-form').addEventListener('submit', submitEditForm);


        // --- FIREBASE/DATA STUBS (Mock functions using Firestore structure) ---

        const getCollectionPath = (collectionName) => {
            if (!userId || userId === 'anonymous') {
                console.warn("Attempted to access Firestore without authenticated user ID.");
                return null;
            }
            // Private data path (as per instructions)
            return `artifacts/${appId}/users/${userId}/${collectionName}`;
        };


        // Function to simulate audit logging
        async function logAudit(action, details) {
            const path = getCollectionPath('audit_logs');
            if (!path) return;
            try {
                await addDoc(collection(db, path), {
                    timestamp: serverTimestamp(),
                    user: currentUserRole,
                    action: action,
                    details: JSON.stringify(details)
                });
                console.log(`Audit Logged: ${action}`);
            } catch (error) {
                console.error("Error logging audit:", error);
            }
        }

        // Dummy data for rendering the table
        const DUMMY_INVENTORY_DATA = [
            { _id: 'inv1', item: 'White Wine', opening: 50, purchases: 10, sales: 5, spoilage: 2, closing: 53, actions: '...'},
            { _id: 'inv2', item: 'Steak Fillets', opening: 100, purchases: 20, sales: 15, spoilage: 5, closing: 100, actions: '...'},
            { _id: 'inv3', item: 'Cleaning Soap', opening: 30, purchases: 5, sales: 1, spoilage: 0, closing: 34, actions: '...'},
        ];

        window.fetchInventory = function() {
            console.log("Fetching Inventory data from Firestore...");
            const path = getCollectionPath('inventory');
            if (!path) return;

            // Mock table rendering
            const tbody = document.querySelector('#inventory-table tbody');
            tbody.innerHTML = ''; 

            DUMMY_INVENTORY_DATA.forEach(item => {
                const row = tbody.insertRow();
                row.className = 'bg-white hover:bg-gray-50';
                row.insertCell().textContent = item.item;
                row.insertCell().textContent = item.opening;
                row.insertCell().textContent = item.purchases;
                row.insertCell().textContent = item.sales;
                row.insertCell().textContent = item.spoilage;
                row.insertCell().textContent = item.closing;
                
                // Action buttons
                const actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button onclick="openEditModal({_id: '${item._id}', item: '${item.item}', opening: ${item.opening}, purchases: ${item.purchases}, sales: ${item.sales}, spoilage: ${item.spoilage}})" 
                            class="text-blue-600 hover:text-blue-800 font-medium mr-2">Edit</button>
                    <button onclick="deleteInventoryItem('${item._id}')" 
                            class="text-red-600 hover:text-red-800 font-medium">Delete</button>
                `;
            });
            logAudit('Fetch', { section: 'Inventory' });
        }

        window.deleteInventoryItem = function(id) {
            console.log(`Simulating deletion of inventory item: ${id}`);
            showMessage(`Item ${id} deleted (Simulated).`, 'green');
            logAudit('Delete', { section: 'Inventory', id: id });
            fetchInventory(); // Re-render table
        }
        
        window.submitInventoryForm = function(event) {
            event.preventDefault();
            console.log("Simulating Inventory Form Submission");
            // Here you would add logic to save to Firestore via addDoc/setDoc
            showMessage('Inventory item saved/updated (Simulated).', 'green');
            logAudit('Save', { section: 'Inventory', item: document.getElementById('item').value });
        }
        document.getElementById('inventory-form').addEventListener('submit', submitInventoryForm);

        window.submitEditForm = function(event) {
            event.preventDefault();
            console.log("Simulating Edit Inventory Form Submission");
            // Here you would add logic to update to Firestore via updateDoc
            showMessage('Inventory item updated (Simulated).', 'green');
            logAudit('Edit', { section: 'Inventory', id: document.getElementById('edit-inventory-id').value });
            closeEditModal();
        }

        // Placeholder functions for other sections (replace with actual Firestore logic)
        window.fetchSales = () => { console.log("Fetching Sales data..."); logAudit('Fetch', { section: 'Sales' }); };
        window.fetchExpenses = () => { console.log("Fetching Expenses data..."); logAudit('Fetch', { section: 'Expenses' }); };
        window.fetchCashJournal = () => { console.log("Fetching Cash Journal data..."); logAudit('Fetch', { section: 'Cash Management' }); };
        window.generateReports = () => { console.log("Generating Reports..."); logAudit('Generate', { section: 'Reports' }); };
        
        // --- EXPORT TO EXCEL FUNCTION ---
        
        window.exportTableToExcel = function(tableContainerId, filename = 'report') {
            const table = document.getElementById(tableContainerId).querySelector('table');
            if (!table) {
                showMessage("Table not found for export.", 'red');
                return;
            }
            
            // Create a workbook and worksheet
            const ws = XLSX.utils.table_to_sheet(table);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            
            // Write to file and download
            XLSX.writeFile(wb, `${filename}_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }

        // --- APPLICATION STARTUP ---
        window.onload = setupAuthAndUI;
    </script>
</body>
</html>
